<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PossibleNow Meetings</title>
    <style>
      :root {
        --bg: #ffffff;
        --card: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --shadow: 0 1px 2px rgba(0,0,0,0.06), 0 8px 24px rgba(0,0,0,0.06);
        --primary: #2563eb;
      }

      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 0;
        background: #f9fafb;
        color: var(--text);
      }

      .container { max-width: 1080px; margin: 28px auto; padding: 0 16px; }
      .header { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; margin-bottom: 14px; }
      .header h2 { margin: 0; font-size: 24px; }
      .header p { margin: 0; color: var(--muted); }

      .grid { display: grid; grid-template-columns: 420px 1fr; gap: 16px; align-items: start; }
      @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 16px;
      }

      .card h3 { margin: 0 0 12px 0; font-size: 16px; }

      .field { margin-bottom: 12px; }
      .label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }

      input, textarea, select {
        width: 100%;
        box-sizing: border-box;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
        background: #fff;
      }
      textarea { min-height: 96px; resize: vertical; }

      .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

      .actions { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
      button {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-weight: 600;
        cursor: pointer;
        background: #fff;
      }
      button.primary { background: var(--primary); color: white; border-color: var(--primary); }
      button:disabled { opacity: 0.6; cursor: not-allowed; }

      .msg { margin-top: 10px; font-size: 13px; color: var(--muted); }

      .chipbox {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 10px;
        background: #fff;
      }
      .chipbox:focus-within { outline: 2px solid rgba(37, 99, 235, 0.25); outline-offset: 2px; }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #f3f4f6;
        font-size: 13px;
      }
      .chip button {
        padding: 0;
        border: none;
        background: transparent;
        font-weight: 800;
        line-height: 1;
      }
      .chipinput {
        border: none;
        outline: none;
        padding: 8px 6px;
        min-width: 180px;
        flex: 1;
        font-size: 14px;
      }

      table { border-collapse: collapse; width: 100%; margin-top: 12px; }
      td, th { border: 1px solid var(--border); padding: 10px; vertical-align: top; }
      th { background: #f3f4f6; text-align: left; font-size: 12px; color: #374151; }
      code { white-space: pre-wrap; font-size: 12px; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div>
          <h2>PossibleNow Meetings</h2>
          <p>This calendar app allows both teams to create meetings that are visible to both companies</p>
        </div>
        <div class="actions">
          <button id="refreshBtn">Refresh</button>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Create meeting</h3>

          <div class="field">
            <label class="label" for="title">Title</label>
            <input id="title" placeholder="Team sync" autocomplete="off" />
          </div>

          <div class="field">
            <div class="label">When</div>
            <div class="row2">
              <div>
                <label class="label" for="start_date">Start date</label>
                <input id="start_date" type="date" />
              </div>
              <div>
                <label class="label" for="start_time">Start time</label>
                <select id="start_time"></select>
              </div>
            </div>
            <div class="row2" style="margin-top: 10px;">
              <div>
                <label class="label" for="end_date">End date</label>
                <input id="end_date" type="date" />
              </div>
              <div>
                <label class="label" for="end_time">End time</label>
                <select id="end_time"></select>
              </div>
            </div>
          </div>

          <div class="field">
            <div class="label">Time zone</div>
            <div class="row2">
              <div>
                <label class="label" for="use_my_tz">Use my time zone</label>
                <select id="use_my_tz">
                  <option value="true">Yes (auto-detect)</option>
                  <option value="false">No (choose)</option>
                </select>
              </div>
              <div>
                <label class="label" for="timezone">Selected time zone</label>
                <input id="timezone" list="tzlist" placeholder="America/New_York" autocomplete="off" />
                <datalist id="tzlist">
                  <option value="America/Los_Angeles"></option>
                  <option value="America/Denver"></option>
                  <option value="America/Chicago"></option>
                  <option value="America/New_York"></option>
                  <option value="America/Phoenix"></option>
                  <option value="Europe/London"></option>
                  <option value="Europe/Paris"></option>
                  <option value="Europe/Berlin"></option>
                  <option value="Asia/Tokyo"></option>
                  <option value="Asia/Singapore"></option>
                  <option value="Australia/Sydney"></option>
                  <option value="UTC"></option>
                </datalist>
              </div>
            </div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 6px;">
              Tip: keep “Use my time zone” on unless you’re scheduling in another city.
            </div>
          </div>

          <div class="field">
            <label class="label" for="location">Location</label>
            <input id="location" placeholder="Conference Room A" autocomplete="off" />
          </div>

          <div class="field">
            <label class="label" for="guests">Guests</label>
            <div class="chipbox" id="guestBox">
              <input id="guestInput" class="chipinput" placeholder="Type email and press Enter" autocomplete="off" />
            </div>
          </div>

          <div class="field">
            <label class="label" for="description">Description</label>
            <textarea id="description" placeholder="Add agenda, notes, links..."></textarea>
          </div>

          <div class="actions">
            <button class="primary" id="createBtn">Create</button>
          </div>
          <div id="msg" class="msg"></div>
        </div>

        <div class="card">
          <h3>Events</h3>
          <table>
            <thead>
              <tr>
                <th>When</th>
                <th>Title</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="eventsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      function esc(s) {
        return (s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
      }

      function pad2(n) { return String(n).padStart(2, "0"); }

      function populateTimeSelect(selectEl) {
        // 15-minute increments
        selectEl.innerHTML = "";
        for (let h = 0; h < 24; h++) {
          for (let m = 0; m < 60; m += 15) {
            const v = `${pad2(h)}:${pad2(m)}`;
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            selectEl.appendChild(opt);
          }
        }
      }

      function setDefaultTimes() {
        const now = new Date();
        // Round up to next quarter hour
        const minutes = now.getMinutes();
        const rounded = new Date(now);
        const add = (15 - (minutes % 15)) % 15;
        rounded.setMinutes(minutes + add, 0, 0);
        const end = new Date(rounded.getTime() + 30 * 60 * 1000);

        const today = `${rounded.getFullYear()}-${pad2(rounded.getMonth() + 1)}-${pad2(rounded.getDate())}`;
        const todayEnd = `${end.getFullYear()}-${pad2(end.getMonth() + 1)}-${pad2(end.getDate())}`;
        document.getElementById("start_date").value = today;
        document.getElementById("end_date").value = todayEnd;
        document.getElementById("start_time").value = `${pad2(rounded.getHours())}:${pad2(rounded.getMinutes())}`;
        document.getElementById("end_time").value = `${pad2(end.getHours())}:${pad2(end.getMinutes())}`;
      }

      function localDateTimeToLocalIso(dateStr, timeStr) {
        // "Local" naive datetime string (no Z / offset). Backend will interpret with chosen IANA time zone.
        // Example: 2025-12-15T10:00:00
        return `${dateStr}T${timeStr}:00`;
      }

      function parseGuests(s) {
        const raw = (s || "").split(",").map(x => x.trim()).filter(Boolean);
        if (!raw.length) return null;
        return raw.map(email => ({ email, type: "required" }));
      }

      // --- Guests chip input (Google Calendar-like) ---
      const guestState = { emails: [] };

      function normalizeEmails(text) {
        // Split on commas/semicolons/whitespace/newlines
        return (text || "")
          .split(/[\s,;]+/g)
          .map(x => x.trim())
          .filter(Boolean);
      }

      function isValidEmail(email) {
        // Lightweight validation (good UX, not RFC-perfect)
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      function addGuest(email) {
        const e = (email || "").trim();
        if (!e) return;
        if (!isValidEmail(e)) return;
        if (guestState.emails.includes(e.toLowerCase())) return;
        guestState.emails.push(e.toLowerCase());
        renderGuests();
      }

      function removeGuest(emailLower) {
        guestState.emails = guestState.emails.filter(x => x !== emailLower);
        renderGuests();
      }

      function renderGuests() {
        const box = document.getElementById("guestBox");
        const input = document.getElementById("guestInput");
        // remove existing chips (keep input)
        Array.from(box.querySelectorAll(".chip")).forEach(n => n.remove());
        guestState.emails.forEach(emailLower => {
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.innerHTML = `<span>${esc(emailLower)}</span>`;
          const btn = document.createElement("button");
          btn.type = "button";
          btn.setAttribute("aria-label", `Remove ${emailLower}`);
          btn.textContent = "×";
          btn.addEventListener("click", () => removeGuest(emailLower));
          chip.appendChild(btn);
          box.insertBefore(chip, input);
        });
      }

      function commitGuestInput() {
        const input = document.getElementById("guestInput");
        const parts = normalizeEmails(input.value);
        parts.forEach(addGuest);
        input.value = "";
      }

      async function refresh() {
        const res = await fetch("/api/events");
        const events = await res.json();
        const body = document.getElementById("eventsBody");
        body.innerHTML = events.map(e => {
          const when = `${e.start_at || ""} → ${e.end_at || ""}`.trim();
          return `<tr>
            <td>${esc(when)}</td>
            <td>${esc(e.title)}</td>
            <td><code>${esc(JSON.stringify(e, null, 2))}</code></td>
          </tr>`;
        }).join("");
      }

      async function create() {
        const detectedTz = Intl.DateTimeFormat().resolvedOptions().timeZone || null;
        const useMyTz = document.getElementById("use_my_tz").value === "true";
        const tz = useMyTz ? detectedTz : (document.getElementById("timezone").value || null);

        const startDate = document.getElementById("start_date").value;
        const startTime = document.getElementById("start_time").value;
        const endDate = document.getElementById("end_date").value;
        const endTime = document.getElementById("end_time").value;

        const startLocal = startDate && startTime ? localDateTimeToLocalIso(startDate, startTime) : null;
        const endLocal = endDate && endTime ? localDateTimeToLocalIso(endDate, endTime) : null;

        const payload = {
          title: document.getElementById("title").value || null,
          start_local: startLocal,
          end_local: endLocal,
          start_timezone: tz,
          end_timezone: tz,
          location: document.getElementById("location").value || null,
          attendees: guestState.emails.length ? guestState.emails.map(email => ({ email, type: "required" })) : null,
          description: document.getElementById("description").value || null,
        };
        const res = await fetch("/api/events", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
        });
        const msg = document.getElementById("msg");
        if (!res.ok) {
          msg.textContent = "Create failed: " + (await res.text());
          return;
        }
        msg.textContent = "Created.";
        await refresh();
      }

      document.getElementById("createBtn").addEventListener("click", create);
      document.getElementById("refreshBtn").addEventListener("click", refresh);
      populateTimeSelect(document.getElementById("start_time"));
      populateTimeSelect(document.getElementById("end_time"));
      setDefaultTimes();
      // initialize timezone UI
      const detected = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
      document.getElementById("timezone").value = detected;
      document.getElementById("timezone").disabled = true;
      document.getElementById("use_my_tz").addEventListener("change", (e) => {
        const useMy = e.target.value === "true";
        const tzInput = document.getElementById("timezone");
        tzInput.disabled = useMy;
        if (useMy) tzInput.value = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
      });

      // initialize guests UI
      document.getElementById("guestBox").addEventListener("click", () => document.getElementById("guestInput").focus());
      document.getElementById("guestInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === ",") {
          e.preventDefault();
          commitGuestInput();
          return;
        }
        if (e.key === "Backspace" && !e.target.value && guestState.emails.length) {
          // Remove last chip like Google Calendar
          removeGuest(guestState.emails[guestState.emails.length - 1]);
        }
      });
      document.getElementById("guestInput").addEventListener("blur", () => {
        // Commit on blur for paste workflows
        commitGuestInput();
      });
      document.getElementById("guestInput").addEventListener("paste", (e) => {
        // If they paste multiple, commit right away
        requestAnimationFrame(() => commitGuestInput());
      });

      refresh();
    </script>
  </body>
</html>


