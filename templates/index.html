<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PossibleNow Meetings</title>
    <style>
      :root {
        --bg: #ffffff;
        --card: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --shadow: 0 1px 2px rgba(0,0,0,0.06), 0 8px 24px rgba(0,0,0,0.06);
        --primary: #2563eb;
      }

      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 0;
        background: #f9fafb;
        color: var(--text);
      }

      .container { max-width: 1080px; margin: 28px auto; padding: 0 16px; }
      .header { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; margin-bottom: 14px; }
      .header h2 { margin: 0; font-size: 24px; }
      .header p { margin: 0; color: var(--muted); }

      .grid { display: grid; grid-template-columns: 420px 1fr; gap: 16px; align-items: start; }
      @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 16px;
      }

      .card h3 { margin: 0 0 12px 0; font-size: 16px; }

      .field { margin-bottom: 12px; }
      .label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }

      input, textarea, select {
        width: 100%;
        box-sizing: border-box;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
        background: #fff;
      }
      textarea { min-height: 96px; resize: vertical; }

      .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

      .actions { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
      button {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-weight: 600;
        cursor: pointer;
        background: #fff;
      }
      button.primary { background: var(--primary); color: white; border-color: var(--primary); }
      button:disabled { opacity: 0.6; cursor: not-allowed; }

      .msg { margin-top: 10px; font-size: 13px; color: var(--muted); }

      .modalOverlay {
        position: fixed;
        inset: 0;
        background: rgba(17, 24, 39, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 9999;
      }
      .modalOverlay.show { display: flex; }
      .modal {
        width: 100%;
        max-width: 440px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        padding: 16px;
      }
      .modal h4 { margin: 0 0 6px 0; font-size: 16px; }
      .modal p { margin: 0 0 12px 0; color: var(--muted); }
      .modal .actions { justify-content: flex-end; }

      .chipbox {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 10px;
        background: #fff;
      }
      .chipbox:focus-within { outline: 2px solid rgba(37, 99, 235, 0.25); outline-offset: 2px; }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #f3f4f6;
        font-size: 13px;
      }
      .chip button {
        padding: 0;
        border: none;
        background: transparent;
        font-weight: 800;
        line-height: 1;
      }
      .chipinput {
        border: none;
        outline: none;
        padding: 8px 6px;
        min-width: 180px;
        flex: 1;
        font-size: 14px;
      }

      .calHeader {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      .calHeaderLeft { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .calTitle { font-weight: 800; }
      .seg {
        display: inline-flex;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
      }
      .seg button {
        border: none;
        border-right: 1px solid var(--border);
        border-radius: 0;
        padding: 8px 10px;
        background: transparent;
        font-weight: 700;
        color: #374151;
      }
      .seg button:last-child { border-right: none; }
      .seg button.active { background: #eef2ff; color: #1d4ed8; }

      .calGrid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
      }
      .dow {
        font-size: 12px;
        color: var(--muted);
        font-weight: 700;
        padding: 0 4px;
      }
      .dayCell {
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fff;
        min-height: 96px;
        padding: 8px;
        cursor: pointer;
      }
      .dayCell.muted { background: #f9fafb; color: #6b7280; }
      .dayNum { font-size: 12px; font-weight: 800; margin-bottom: 6px; }
      .eventPill {
        display: block;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #f3f4f6;
        margin-bottom: 6px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .list {
        display: grid;
        gap: 10px;
      }
      .listGroupTitle {
        font-size: 12px;
        color: var(--muted);
        font-weight: 800;
        margin-top: 8px;
      }
      .listItem {
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fff;
        padding: 10px;
      }
      .listItemTop { display: flex; justify-content: space-between; gap: 10px; }
      .listItemTitle { font-weight: 800; }
      .listItemMeta { color: var(--muted); font-size: 12px; }
      details { margin-top: 8px; }

      table { border-collapse: collapse; width: 100%; margin-top: 12px; }
      td, th { border: 1px solid var(--border); padding: 10px; vertical-align: top; }
      th { background: #f3f4f6; text-align: left; font-size: 12px; color: #374151; }
      code { white-space: pre-wrap; font-size: 12px; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div>
          <h2>PossibleNow Meetings</h2>
          <p>This calendar app allows both teams to create meetings that are visible to both companies</p>
        </div>
        <div class="actions">
          <button id="refreshBtn">Refresh</button>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Create meeting</h3>

          <div class="field">
            <label class="label" for="title">Title</label>
            <input id="title" placeholder="Team sync" autocomplete="off" />
          </div>

          <div class="field">
            <div class="label">When</div>
            <div class="row2">
              <div>
                <label class="label" for="start_date">Start date</label>
                <input id="start_date" type="date" />
              </div>
              <div>
                <label class="label" for="start_time">Start time</label>
                <select id="start_time"></select>
              </div>
            </div>
            <div class="row2" style="margin-top: 10px;">
              <div>
                <label class="label" for="end_date">End date</label>
                <input id="end_date" type="date" />
              </div>
              <div>
                <label class="label" for="end_time">End time</label>
                <select id="end_time"></select>
              </div>
            </div>
          </div>

          <div class="field">
            <div class="label">Time zone</div>
            <div class="row2">
              <div>
                <label class="label" for="use_my_tz">Use my time zone</label>
                <select id="use_my_tz">
                  <option value="true">Yes (auto-detect)</option>
                  <option value="false">No (choose)</option>
                </select>
              </div>
              <div>
                <label class="label" for="timezone">Selected time zone</label>
                <input id="timezone" list="tzlist" placeholder="America/New_York" autocomplete="off" />
                <datalist id="tzlist">
                  <option value="America/Los_Angeles"></option>
                  <option value="America/Denver"></option>
                  <option value="America/Chicago"></option>
                  <option value="America/New_York"></option>
                  <option value="America/Phoenix"></option>
                  <option value="Europe/London"></option>
                  <option value="Europe/Paris"></option>
                  <option value="Europe/Berlin"></option>
                  <option value="Asia/Tokyo"></option>
                  <option value="Asia/Singapore"></option>
                  <option value="Australia/Sydney"></option>
                  <option value="UTC"></option>
                </datalist>
              </div>
            </div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 6px;">
              Tip: keep “Use my time zone” on unless you’re scheduling in another city.
            </div>
          </div>

          <div class="field">
            <label class="label" for="location">Location</label>
            <input id="location" placeholder="Conference Room A" autocomplete="off" />
          </div>

          <div class="field">
            <label class="label" for="guests">Guests</label>
            <div class="chipbox" id="guestBox">
              <input id="guestInput" class="chipinput" placeholder="Type email and press Enter" autocomplete="off" />
            </div>
          </div>

          <div class="field">
            <label class="label" for="description">Description</label>
            <textarea id="description" placeholder="Add agenda, notes, links..."></textarea>
          </div>

          <div class="actions">
            <button class="primary" id="createBtn">Create</button>
          </div>
          <div id="msg" class="msg"></div>
        </div>

        <div class="card">
          <div class="calHeader">
            <div class="calHeaderLeft">
              <div class="calTitle" id="calTitle">Calendar</div>
              <div class="seg" id="viewSeg">
                <button type="button" data-view="month" class="active">Month</button>
                <button type="button" data-view="day">Day</button>
                <button type="button" data-view="schedule">Schedule</button>
                <button type="button" data-view="all">All</button>
              </div>
            </div>
            <div class="calHeaderLeft">
              <button type="button" id="calPrevBtn">Prev</button>
              <button type="button" id="calTodayBtn">Today</button>
              <button type="button" id="calNextBtn">Next</button>
            </div>
          </div>
          <div id="calendarRoot"></div>
        </div>
      </div>
    </div>

    <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalBody">
      <div class="modal">
        <h4 id="modalTitle">Meeting created</h4>
        <p id="modalBody">Your meeting has been saved and is visible to both teams.</p>
        <div class="actions">
          <button class="primary" id="modalOkBtn">OK</button>
        </div>
      </div>
    </div>

    <script>
      function esc(s) {
        return (s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
      }

      function pad2(n) { return String(n).padStart(2, "0"); }

      function populateTimeSelect(selectEl) {
        // 15-minute increments
        selectEl.innerHTML = "";
        for (let h = 0; h < 24; h++) {
          for (let m = 0; m < 60; m += 15) {
            const v = `${pad2(h)}:${pad2(m)}`;
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            selectEl.appendChild(opt);
          }
        }
      }

      function setDefaultTimes() {
        const now = new Date();
        // Round up to next quarter hour
        const minutes = now.getMinutes();
        const rounded = new Date(now);
        const add = (15 - (minutes % 15)) % 15;
        rounded.setMinutes(minutes + add, 0, 0);
        const end = new Date(rounded.getTime() + 30 * 60 * 1000);

        const today = `${rounded.getFullYear()}-${pad2(rounded.getMonth() + 1)}-${pad2(rounded.getDate())}`;
        const todayEnd = `${end.getFullYear()}-${pad2(end.getMonth() + 1)}-${pad2(end.getDate())}`;
        document.getElementById("start_date").value = today;
        document.getElementById("end_date").value = todayEnd;
        document.getElementById("start_time").value = `${pad2(rounded.getHours())}:${pad2(rounded.getMinutes())}`;
        document.getElementById("end_time").value = `${pad2(end.getHours())}:${pad2(end.getMinutes())}`;
      }

      function localDateTimeToLocalIso(dateStr, timeStr) {
        // "Local" naive datetime string (no Z / offset). Backend will interpret with chosen IANA time zone.
        // Example: 2025-12-15T10:00:00
        return `${dateStr}T${timeStr}:00`;
      }

      function parseGuests(s) {
        const raw = (s || "").split(",").map(x => x.trim()).filter(Boolean);
        if (!raw.length) return null;
        return raw.map(email => ({ email, type: "required" }));
      }

      // --- Guests chip input (Google Calendar-like) ---
      const guestState = { emails: [] };

      function normalizeEmails(text) {
        // Split on commas/semicolons/whitespace/newlines
        return (text || "")
          .split(/[\s,;]+/g)
          .map(x => x.trim())
          .filter(Boolean);
      }

      function isValidEmail(email) {
        // Lightweight validation (good UX, not RFC-perfect)
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }

      function addGuest(email) {
        const e = (email || "").trim();
        if (!e) return;
        if (!isValidEmail(e)) return;
        if (guestState.emails.includes(e.toLowerCase())) return;
        guestState.emails.push(e.toLowerCase());
        renderGuests();
      }

      function removeGuest(emailLower) {
        guestState.emails = guestState.emails.filter(x => x !== emailLower);
        renderGuests();
      }

      function renderGuests() {
        const box = document.getElementById("guestBox");
        const input = document.getElementById("guestInput");
        // remove existing chips (keep input)
        Array.from(box.querySelectorAll(".chip")).forEach(n => n.remove());
        guestState.emails.forEach(emailLower => {
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.innerHTML = `<span>${esc(emailLower)}</span>`;
          const btn = document.createElement("button");
          btn.type = "button";
          btn.setAttribute("aria-label", `Remove ${emailLower}`);
          btn.textContent = "×";
          btn.addEventListener("click", () => removeGuest(emailLower));
          chip.appendChild(btn);
          box.insertBefore(chip, input);
        });
      }

      function commitGuestInput() {
        const input = document.getElementById("guestInput");
        const parts = normalizeEmails(input.value);
        parts.forEach(addGuest);
        input.value = "";
      }

      // --- Modal popup ---
      let modalTimer = null;
      function hideModal() {
        const overlay = document.getElementById("modalOverlay");
        overlay.classList.remove("show");
        if (modalTimer) {
          clearTimeout(modalTimer);
          modalTimer = null;
        }
      }

      function showModal(title, body, autoCloseMs = 5000) {
        const overlay = document.getElementById("modalOverlay");
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalBody").textContent = body;
        overlay.classList.add("show");
        document.getElementById("modalOkBtn").focus();
        if (modalTimer) clearTimeout(modalTimer);
        modalTimer = setTimeout(() => hideModal(), autoCloseMs);
      }

      async function refresh() {
        const res = await fetch("/api/events");
        calendarState.events = await res.json();
        renderCalendar();
      }

      async function create() {
        const detectedTz = Intl.DateTimeFormat().resolvedOptions().timeZone || null;
        const useMyTz = document.getElementById("use_my_tz").value === "true";
        const tz = useMyTz ? detectedTz : (document.getElementById("timezone").value || null);

        const startDate = document.getElementById("start_date").value;
        const startTime = document.getElementById("start_time").value;
        const endDate = document.getElementById("end_date").value;
        const endTime = document.getElementById("end_time").value;

        const startLocal = startDate && startTime ? localDateTimeToLocalIso(startDate, startTime) : null;
        const endLocal = endDate && endTime ? localDateTimeToLocalIso(endDate, endTime) : null;

        const payload = {
          title: document.getElementById("title").value || null,
          start_local: startLocal,
          end_local: endLocal,
          start_timezone: tz,
          end_timezone: tz,
          location: document.getElementById("location").value || null,
          attendees: guestState.emails.length ? guestState.emails.map(email => ({ email, type: "required" })) : null,
          description: document.getElementById("description").value || null,
        };
        const res = await fetch("/api/events", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
        });
        const msg = document.getElementById("msg");
        if (!res.ok) {
          msg.textContent = "Create failed: " + (await res.text());
          return;
        }
        msg.textContent = "Created.";
        showModal("Meeting created", "Your meeting has been saved and is visible to both teams.", 5000);
        await refresh();
      }

      document.getElementById("createBtn").addEventListener("click", create);
      document.getElementById("refreshBtn").addEventListener("click", refresh);
      populateTimeSelect(document.getElementById("start_time"));
      populateTimeSelect(document.getElementById("end_time"));
      setDefaultTimes();
      // initialize timezone UI
      const detected = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
      document.getElementById("timezone").value = detected;
      document.getElementById("timezone").disabled = true;
      document.getElementById("use_my_tz").addEventListener("change", (e) => {
        const useMy = e.target.value === "true";
        const tzInput = document.getElementById("timezone");
        tzInput.disabled = useMy;
        if (useMy) tzInput.value = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
      });

      // initialize guests UI
      document.getElementById("guestBox").addEventListener("click", () => document.getElementById("guestInput").focus());
      document.getElementById("guestInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === ",") {
          e.preventDefault();
          commitGuestInput();
          return;
        }
        if (e.key === "Backspace" && !e.target.value && guestState.emails.length) {
          // Remove last chip like Google Calendar
          removeGuest(guestState.emails[guestState.emails.length - 1]);
        }
      });
      document.getElementById("guestInput").addEventListener("blur", () => {
        // Commit on blur for paste workflows
        commitGuestInput();
      });
      document.getElementById("guestInput").addEventListener("paste", (e) => {
        // If they paste multiple, commit right away
        requestAnimationFrame(() => commitGuestInput());
      });

      // initialize modal
      document.getElementById("modalOkBtn").addEventListener("click", hideModal);
      document.getElementById("modalOverlay").addEventListener("click", (e) => {
        // click outside closes as well
        if (e.target.id === "modalOverlay") hideModal();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") hideModal();
      });

      // --- Calendar view (Month / Day / Schedule / All) ---
      const calendarState = {
        view: "month",
        cursor: new Date(),
        events: [],
      };

      const dtfDate = new Intl.DateTimeFormat(undefined, { weekday: "short", month: "short", day: "numeric", year: "numeric" });
      const dtfMonth = new Intl.DateTimeFormat(undefined, { month: "long", year: "numeric" });
      const dtfTime = new Intl.DateTimeFormat(undefined, { hour: "numeric", minute: "2-digit" });

      function startOfDay(d) {
        const x = new Date(d);
        x.setHours(0,0,0,0);
        return x;
      }
      function addDays(d, n) {
        const x = new Date(d);
        x.setDate(x.getDate() + n);
        return x;
      }
      function ymd(d) {
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      }

      function eventStartDate(e) {
        if (!e.start_at) return null;
        const d = new Date(e.start_at);
        return isNaN(d.getTime()) ? null : d;
      }
      function eventEndDate(e) {
        if (!e.end_at) return null;
        const d = new Date(e.end_at);
        return isNaN(d.getTime()) ? null : d;
      }

      function eventsForDay(day) {
        const dayKey = ymd(day);
        const list = calendarState.events
          .map(ev => ({ ev, s: eventStartDate(ev), en: eventEndDate(ev) }))
          .filter(x => x.s && ymd(x.s) === dayKey)
          .sort((a,b) => a.s - b.s)
          .map(x => x.ev);
        return list;
      }

      function setView(view) {
        calendarState.view = view;
        document.querySelectorAll("#viewSeg button").forEach(b => b.classList.toggle("active", b.dataset.view === view));
        renderCalendar();
      }

      function setCursor(dateObj) {
        calendarState.cursor = new Date(dateObj);
        renderCalendar();
      }

      function renderCalendar() {
        const root = document.getElementById("calendarRoot");
        const title = document.getElementById("calTitle");

        if (calendarState.view === "month") {
          const c = calendarState.cursor;
          title.textContent = dtfMonth.format(c);
          root.innerHTML = renderMonthHtml(c);
          // bind day clicks
          root.querySelectorAll("[data-day]").forEach(el => {
            el.addEventListener("click", () => {
              const [y, m, d] = el.dataset.day.split("-").map(Number);
              setCursor(new Date(y, m - 1, d));
              setView("day");
            });
          });
          return;
        }

        if (calendarState.view === "day") {
          const day = startOfDay(calendarState.cursor);
          title.textContent = dtfDate.format(day);
          root.innerHTML = renderDayHtml(day);
          return;
        }

        if (calendarState.view === "schedule") {
          const start = startOfDay(calendarState.cursor);
          title.textContent = `Schedule (next 14 days)`;
          root.innerHTML = renderScheduleHtml(start, 14);
          return;
        }

        // all
        title.textContent = "All events";
        root.innerHTML = renderAllHtml();
      }

      function renderMonthHtml(cursor) {
        const year = cursor.getFullYear();
        const month = cursor.getMonth();
        const first = new Date(year, month, 1);
        const start = addDays(first, -first.getDay()); // Sunday-start grid
        const dow = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

        const cells = [];
        for (let i = 0; i < 42; i++) {
          const day = addDays(start, i);
          const inMonth = day.getMonth() === month;
          const evs = eventsForDay(day);
          const pills = evs.slice(0, 3).map(ev => {
            const s = eventStartDate(ev);
            const t = s ? dtfTime.format(s) : "";
            const label = `${t} ${ev.title || "(untitled)"}`.trim();
            return `<span class="eventPill" title="${esc(label)}">${esc(label)}</span>`;
          }).join("");
          const more = evs.length > 3 ? `<div class="listItemMeta">+${evs.length - 3} more</div>` : "";
          cells.push(
            `<div class="dayCell ${inMonth ? "" : "muted"}" data-day="${ymd(day)}">
              <div class="dayNum">${day.getDate()}</div>
              ${pills}
              ${more}
            </div>`
          );
        }

        const dowRow = dow.map(d => `<div class="dow">${d}</div>`).join("");
        return `
          <div class="calGrid">${dowRow}</div>
          <div class="calGrid" style="margin-top: 8px;">${cells.join("")}</div>
        `;
      }

      function renderDayHtml(day) {
        const evs = eventsForDay(day);
        if (!evs.length) {
          return `<div class="listItemMeta">No events for this day.</div>`;
        }
        return `<div class="list">${evs.map(renderEventItem).join("")}</div>`;
      }

      function renderScheduleHtml(startDay, days) {
        const groups = [];
        for (let i = 0; i < days; i++) {
          const day = addDays(startDay, i);
          const evs = eventsForDay(day);
          if (!evs.length) continue;
          groups.push(`<div class="listGroupTitle">${dtfDate.format(day)}</div>`);
          groups.push(`<div class="list">${evs.map(renderEventItem).join("")}</div>`);
        }
        return groups.length ? groups.join("") : `<div class="listItemMeta">No upcoming events in this range.</div>`;
      }

      function renderAllHtml() {
        const items = calendarState.events
          .map(ev => ({ ev, s: eventStartDate(ev) }))
          .sort((a,b) => (a.s?.getTime() || 0) - (b.s?.getTime() || 0))
          .map(x => x.ev);
        if (!items.length) return `<div class="listItemMeta">No events yet.</div>`;
        return `<div class="list">${items.map(renderEventItem).join("")}</div>`;
      }

      function renderEventItem(ev) {
        const s = eventStartDate(ev);
        const en = eventEndDate(ev);
        const when = s ? `${dtfDate.format(s)} ${dtfTime.format(s)}${en ? ` → ${dtfTime.format(en)}` : ""}` : "(no time)";
        const loc = ev.location ? ` • ${ev.location}` : "";
        return `
          <div class="listItem">
            <div class="listItemTop">
              <div class="listItemTitle">${esc(ev.title || "(untitled)")}</div>
              <div class="listItemMeta">${esc(when)}</div>
            </div>
            <div class="listItemMeta">${esc((ev.description || "").slice(0, 140))}${esc(loc)}</div>
            <details>
              <summary class="listItemMeta">Details</summary>
              <code>${esc(JSON.stringify(ev, null, 2))}</code>
            </details>
          </div>
        `;
      }

      // calendar controls
      document.getElementById("viewSeg").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-view]");
        if (!btn) return;
        setView(btn.dataset.view);
      });
      document.getElementById("calTodayBtn").addEventListener("click", () => setCursor(new Date()));
      document.getElementById("calPrevBtn").addEventListener("click", () => {
        const c = calendarState.cursor;
        if (calendarState.view === "month") setCursor(new Date(c.getFullYear(), c.getMonth() - 1, 1));
        else setCursor(addDays(c, -1));
      });
      document.getElementById("calNextBtn").addEventListener("click", () => {
        const c = calendarState.cursor;
        if (calendarState.view === "month") setCursor(new Date(c.getFullYear(), c.getMonth() + 1, 1));
        else setCursor(addDays(c, 1));
      });

      refresh();
    </script>
  </body>
</html>


